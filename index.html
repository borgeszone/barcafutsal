<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barça futsal</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <!-- FullCalendar CSS y JS -->
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <link rel="icon" href="images/logo.png" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="position-relative">

    <div id="login-overlay">
    <h2>Ingresa la contraseña</h2>
    <input type="password" id="password-input" placeholder="Contraseña" />
    <button onclick="verificarPassword()">Entrar</button>
    <p id="login-error">Contraseña incorrecta</p>
  </div>

    <div class="container" id="app">
      <div class="row">
        <!-- S1: Lista de Jugadores -->
        <div class="col-md-4 border-end p-4 position-relative" id="s1">
          <p class="mb-3 h2">Plantilla</p>
          <div class="row row-cols-2 row-cols-sm-3 row-cols-md-3 row-cols-lg-3 jugadores-lista mb-5 list-unstyled">
            <div class="col text-center jugador-card"
              data-nombre="Dídac"
              data-numero="21"
              data-posicion="Portero"
              data-nacimiento="1990-05-22"
              data-img="images/didac.jpg">
              <img src="images/didac.jpg" class="img-thumbnail" />
              <!-- <p class="small">21 - Dídac</p> -->
            </div>

            <!-- Miquel Feixas -->
            <div class="col text-center jugador-card"
              data-nombre="Miquel Feixas"
              data-numero="26"
              data-posicion="Portero"
              data-nacimiento="1997-09-04"
              data-img="images/feixas.jpg">
              <img src="images/feixas.jpg" alt="Miquel Feixas" class="img-thumbnail" />
              <!-- <p class="small">26 - Feixas</p> -->
            </div>

            <!-- Iker (Iker Abad) -->
            <div class="col text-center jugador-card"
              data-nombre="Iker Abad"
              data-numero="15"
              data-posicion="Portero"
              data-nacimiento="2006-06-15"
              data-img="images/iker.jpg">
              <img src="images/iker.jpg" alt="Iker" class="img-thumbnail" />
              <!-- <p class="small">15 - Iker</p> -->
            </div>

            <!-- Antonio Pérez Ortega -->
            <div class="col text-center jugador-card"
              data-nombre="Antonio Pérez Ortega"
              data-numero="6"
              data-posicion="Cierre"
              data-nacimiento="2000-10-19"
              data-img="images/antonio.jpg">
              <img src="images/antonio.jpg" alt="Antonio" class="img-thumbnail" />
              <!-- <p class="small">6 - Antonio</p> -->
            </div>

            <!-- Erick Mendonça -->
            <div class="col text-center jugador-card"
              data-nombre="Erick Mendonça"
              data-numero="17"
              data-posicion="Cierre"
              data-nacimiento="1995-07-21"
              data-img="images/erick.jpg">
              <img src="images/erick.jpg" alt="Erick" class="img-thumbnail" />
              <!-- <p class="small">17 - Erick</p> -->
            </div>

            <!-- Matheus Rodrigues -->
            <div class="col text-center jugador-card"
              data-nombre="Matheus Rodrigues"
              data-numero="3"
              data-posicion="Ala"
              data-nacimiento="1996-10-03"
              data-img="images/matheus.jpg">
              <img src="images/matheus.jpg" alt="Matheus" class="img-thumbnail" />
              <!-- <p class="small">3 - Matheus</p> -->
            </div>

            <!-- Adolfo Fernández Díaz -->
            <div class="col text-center jugador-card"
              data-nombre="Adolfo Fernández Díaz"
              data-numero="8"
              data-posicion="Ala"
              data-nacimiento="1993-05-19"
              data-img="images/adolfo.jpg">
              <img src="images/adolfo.jpg" alt="Adolfo" class="img-thumbnail" />
              <!-- <p class="small">8 - Adolfo</p> -->
            </div>

            <!-- Catela (Juan José Camacho Pérez) -->
            <div class="col text-center jugador-card"
              data-nombre="Juan José Camacho Pérez"
              data-numero="13"
              data-posicion="Ala"
              data-nacimiento="1995-04-14"
              data-img="images/catela.jpg">
              <img src="images/catela.jpg" alt="Iker" class="img-thumbnail" />
              <!-- <p class="small">13 - Catela</p> -->
            </div>

            <!-- João Victor -->
            <div class="col text-center jugador-card"
              data-nombre="João Victor"
              data-numero="20"
              data-posicion="Ala"
              data-nacimiento="2000-07-12"
              data-img="images/joao.jpg">
              <img src="images/joao.jpg" alt="Lozano" class="img-thumbnail" />
              <!-- <p class="small">20 - Joao</p> -->
            </div>

            <!-- Pol Pacheco -->
            <div class="col text-center jugador-card"
              data-nombre="Pol Pacheco"
              data-numero="13"
              data-posicion="Ala"
              data-nacimiento="1994-07-11"
              data-img="images/pacheco.jpg">
              <img src="images/pacheco.jpg" alt="Pol" class="img-thumbnail" />
              <!-- <p class="small">13 - Pol</p> -->
            </div>

            <!-- Eric Martel García -->
            <div class="col text-center jugador-card"
              data-nombre="Eric Martel García"
              data-numero="14"
              data-posicion="Ala"
              data-nacimiento="1992-02-24"
              data-img="images/martel.jpg">
              <img src="images/martel.jpg" alt="Martel" class="img-thumbnail" />
              <!-- <p class="small">14 - Martel</p> -->
            </div>

            <!-- Sergio González Pérez -->
            <div class="col text-center jugador-card"
              data-nombre="Sergio González Pérez"
              data-numero="16"
              data-posicion="Ala"
              data-nacimiento="1997-06-30"
              data-img="images/sergio.jpg">
              <img src="images/sergio.jpg" alt="S. González" class="img-thumbnail" />
              <!-- <p class="small">16 - S. González</p> -->
            </div>

            <!-- Touré (Mamadou Siragassy Touré) -->
            <div class="col text-center jugador-card"
              data-nombre="Mamadou Siragassy Touré"
              data-numero="20"
              data-posicion="Ala"
              data-nacimiento="2001-09-15"
              data-img="images/toure.jpg">
              <img src="images/toure.jpg" alt="Touré" class="img-thumbnail" />
              <!-- <p class="small">20 - Touré</p> -->
            </div>

            <!-- Luciano Gauna -->
            <div class="col text-center jugador-card"
              data-nombre="Luciano Gauna"
              data-numero="22"
              data-posicion="Ala"
              data-nacimiento="2001-02-24"
              data-img="images/luciano.jpg">
              <img src="images/luciano.jpg" alt="Luciano" class="img-thumbnail" />
              <!-- <p class="small">22 - Luciano</p> -->
            </div>

            <!-- Rubén Rodó -->
            <div class="col text-center jugador-card"
              data-nombre="Rubén Rodó"
              data-numero="24"
              data-posicion="Ala"
              data-nacimiento="2005-05-08"
              data-img="images/ruben.jpg">
              <img src="images/ruben.jpg" alt="Rubén Rodó" class="img-thumbnail" />
              <!-- <p class="small">24 - Rubén Rodó</p> -->
            </div>

            <!-- Pito (Jean Pierre Guisel Costa) -->
            <div class="col text-center jugador-card"
              data-nombre="Jean Pierre Guisel Costa"
              data-numero="10"
              data-posicion="Pívot"
              data-nacimiento="1991-11-06"
              data-img="images/pito.jpg">
              <img src="images/pito.jpg" alt="Pito" class="img-thumbnail" />
              <!-- <p class="small">10 - Pito</p> -->
            </div>

            <!-- Fits (Rafael Nogueira da Silva) -->
            <div class="col text-center jugador-card"
              data-nombre="Rafael Nogueira da Silva"
              data-numero="19"
              data-posicion="Pívot"
              data-nacimiento="1992-05-23"
              data-img="images/fits.jpg">
              <img src="images/fits.jpg" alt="Fits" class="img-thumbnail" />
              <!-- <p class="small">19 - Fits</p> -->
            </div>

            <!-- Botón para añadir nuevo jugador -->
            <div id="add-jugador-btn" class="jugador-card text-center border rounded d-flex flex-column align-items-center justify-content-center add-jugador-card" style="cursor: pointer; background-color: #f0f0f0">
              <div class="d-flex flex-column align-items-center">
                <span style="font-size: 2rem; color: #1a5fad">+</span>
                <p class="small mt-2">Añadir jugador</p>
              </div>
            </div>
          </div>
          <!-- Botones: Notas y Calendario juntos -->
          <div class="d-flex justify-content-center gap-4 mt-3">
            <!-- Botón Notas -->
            <div id="notas-icono" style="cursor: pointer; text-align: center">
              <i class="fa-regular fa-note-sticky fa-xl"></i>
              <p class="small mt-1">Notas</p>
            </div>

            <!-- Botón Calendario -->
            <div id="calendario-icono" style="cursor: pointer; text-align: center">
              <i class="fa-regular fa-calendar-days fa-xl"></i>
              <p class="small mt-1">Calendario</p>
            </div>
          </div>

          <!-- Modal Añadir Jugador -->
          <div
            class="modal fade"
            id="modalAddJugador"
            tabindex="-1"
            aria-labelledby="modalAddJugadorLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <p class="modal-title h5" id="modalAddJugadorLabel">
                    Nuevo Jugador
                  </p>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Cerrar"
                  ></button>
                </div>
                <div class="modal-body">
                  <form id="formNuevoJugador">
                    <div class="mb-3">
                      <label for="nombreNuevo" class="form-label">Nombre</label>
                      <input
                        type="text"
                        class="form-control"
                        id="nombreNuevo"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label for="numeroNuevo" class="form-label">Número</label>
                      <input
                        type="number"
                        class="form-control"
                        id="numeroNuevo"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label for="posicionNuevo" class="form-label"
                        >Posición</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="posicionNuevo"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label for="edadNuevo" class="form-label">Edad</label>
                      <input
                        type="number"
                        class="form-control"
                        id="edadNuevo"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label for="fotoNuevo" class="form-label"
                        >Imagen desde tu dispositivo</label
                      >
                      <input
                        type="file"
                        class="form-control"
                        id="fotoNuevo"
                        accept="image/*"
                      />
                    </div>
                    <button type="submit" class="btn btn-primary">
                      Agregar
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- S2: Información del Jugador -->
        <div class="col-md-8 p-4" id="s2">
          <!-- Skeleton: por defecto visible -->
          <div id="jugador-skeleton">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="d-flex align-items-center w-100">
                <div class="skeleton skeleton-img me-3"></div>
                <div class="w-100">
                  <div class="skeleton skeleton-line w-75"></div>
                  <div class="skeleton skeleton-line w-50"></div>
                  <div class="skeleton skeleton-line w-50"></div>
                </div>
              </div>
            </div>
          </div>
          <!-- Panel con FullCalendar -->
          <div id="calendario-panel" style="display: none">
            <p class="h2 mb-4">Calendario Médico</p>
            <div id="fullcalendar"></div>
          </div>

          <!-- Contenido real del jugador (oculto inicialmente) -->
          <div id="jugador-info" style="display: none">
            <div class="d-flex align-items-center justify-content-between mb-4">
              <div class="d-flex align-items-center">
                <img id="jugador-img" class="rounded-circle me-3" style="width: 9.375rem; height: 9.375rem; object-fit: cover;"/>
                <div>
                  <p class="h4" id="jugador-nombre">Nombre</p>
                  <p class="mb-0">Edad: <span id="jugador-edad">--</span></p>
                  <p class="mb-0">
                    Posición: <span id="jugador-posicion">--</span>
                  </p>
                </div>
              </div>
              <button class="btn" onclick="toggleHistorial()">
                <i class="fa-solid fa-laptop-medical fa-xl"></i>
              </button>
            </div>

            <!-- Comentarios -->
            <div class="mb-4">
              <p class="h4">Comentarios</p>
              <div class="mb-3">
                <textarea
                  id="comentario-input"
                  class="form-control"
                  rows="4"
                  placeholder="Escribe un comentario..."
                ></textarea>
              </div>
              <div class="mb-3">
                <button
                  class="btn"
                  id="btn-comentar"
                  style="background-color: #1d337e; color: white"
                >
                  Guardar
                </button>
              </div>
            </div>

            <!-- Historial -->
            <div
              id="historialOverlay"
              class="overflow-auto timeline d-none mb-5"
              style="max-height: 500px"
            >
              <div
                class="d-flex justify-content-between align-items-center mb-2"
              >
                <p class="mb-0 h4">Historial</p>
                <button
                  class="btn btn-sm btn-outline-danger"
                  onclick="toggleHistorial()"
                >
                  Cerrar
                </button>
              </div>
              <div class="overflow-auto" style="max-height: 300px"></div>
            </div>
          </div>
          <!-- Panel de Notas Generales -->
          <div id="notas-panel" style="display: none">
            <p class="h2 mb-3">Notas generales</p>
            <div class="mb-3">
              <textarea
                id="nota-general-input"
                class="form-control"
                rows="4"
                placeholder="Escribe una nota..."
              ></textarea>
            </div>
            <button class="btn btn-primary mb-4" id="btn-guardar-nota">
              Guardar Nota
            </button>

            <p class="h5">Historial</p>
            <div
              id="historial-notas"
              class="overflow-auto"
              style="max-height: 300px"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // SHA-256 hash de la contraseña 'futsal2025'
    const HASH_ESPERADO = "6ebf6de75e988c516891992ce06d59efef8debf13d084f7aaa8bea635c41ed1f";

    async function verificarPassword() {
      const input = document.getElementById("password-input").value;
      const hash = await sha256(input);
      const error = document.getElementById("login-error");

      if (hash === HASH_ESPERADO) {
        document.getElementById("login-overlay").style.display = "none";
        document.getElementById("app").style.display = "block";
        sessionStorage.setItem("accesoPermitido", "true");
      } else {
        error.style.display = "block";
      }
    }

    // Calcular SHA-256
    async function sha256(text) {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Mostrar app si ya pasó la verificación
    window.addEventListener("DOMContentLoaded", () => {
      if (sessionStorage.getItem("accesoPermitido") === "true") {
        document.getElementById("login-overlay").style.display = "none";
        document.getElementById("app").style.display = "block";
      }
    });

      document.addEventListener("DOMContentLoaded", () => {
        let jugadorActual = null;

        function seleccionarJugador(card) {
          const { nombre, numero, nacimiento, posicion, img } = card.dataset;

          jugadorActual = nombre;

          const imgSrc =
            img || "https://via.placeholder.com/100x100.png?text=Jugador";
            document.getElementById("jugador-nombre").textContent = nombre;
            document.getElementById("jugador-posicion").textContent = posicion;
            document.getElementById("jugador-img").src = imgSrc;

          if (nacimiento) {
            const edadCalculada = calcularEdad(nacimiento);
            document.getElementById(
              "jugador-edad"
            ).textContent = `${edadCalculada} años`;
          } else {
            document.getElementById("jugador-edad").textContent = "--";
          }
          document.getElementById("calendario-panel").style.display = "none";
          document.getElementById("notas-panel").style.display = "none";
          document.getElementById("jugador-skeleton").style.display = "none";
          document.getElementById("jugador-info").style.display = "block";

          cargarComentarios(nombre);
        }

        function calcularEdad(fechaNacimientoStr) {
          const hoy = new Date();
          const [anio, mes, dia] = fechaNacimientoStr.split("-").map(Number);
          const nacimiento = new Date(anio, mes - 1, dia);
          let edad = hoy.getFullYear() - nacimiento.getFullYear();
          const cumpleEsteAnio = new Date(hoy.getFullYear(), mes - 1, dia);
          if (hoy < cumpleEsteAnio) edad--;
          return edad;
        }

        function guardarJugadorEnLocalStorage(jugador) {
          const jugadores = JSON.parse(localStorage.getItem("jugadores")) || [];
          jugadores.push(jugador);
          localStorage.setItem("jugadores", JSON.stringify(jugadores));
        }

        // 🟢 CARGAR jugadores guardados al iniciar
        function cargarJugadoresDesdeLocalStorage() {
          const jugadores = JSON.parse(localStorage.getItem("jugadores")) || [];
          const container = document.querySelector(".jugadores-lista");
          const addBtn = document.getElementById("add-jugador-btn");

          jugadores.forEach(({ nombre, numero, posicion, edad, img }) => {
            const nuevaCard = document.createElement("div");
            nuevaCard.className = "col text-center jugador-card";
            Object.assign(nuevaCard.dataset, {
              nombre,
              numero,
              posicion,
              edad,
              img,
            });

            nuevaCard.innerHTML = `<img src="${img}" alt="${nombre}" class="img-thumbnail" />
          <p class="small">${numero} - ${nombre}</p>`;

            container.insertBefore(nuevaCard, addBtn);
            asignarEventosJugadorCard(nuevaCard);
          });
        }

        
        function asignarEventosJugadorCard(card) {
          card.addEventListener("click", () => seleccionarJugador(card));
        }

        document.querySelectorAll(".jugador-card").forEach(asignarEventosJugadorCard);

        const addBtn = document.getElementById("add-jugador-btn");
        if (addBtn) {
          addBtn.addEventListener("click", () => {
            const modal = new bootstrap.Modal(
              document.getElementById("modalAddJugador")
            );
            modal.show();
          });
        }

        const form = document.getElementById("formNuevoJugador");
        if (form) {
          form.addEventListener("submit", function (e) {
            e.preventDefault();

            const nombre = document.getElementById("nombreNuevo").value.trim();
            const numero = document.getElementById("numeroNuevo").value.trim();
            const posicion = document
              .getElementById("posicionNuevo")
              .value.trim();
            const edad = document.getElementById("edadNuevo").value.trim();
            const fileInput = document.getElementById("fotoNuevo");
            const file = fileInput.files[0];

            const reader = new FileReader();
            reader.onload = function (event) {
              const img =
                event.target.result ||
                "https://via.placeholder.com/100x100.png?text=Jugador";

              const nuevaCard = document.createElement("div");
              nuevaCard.className = "col text-center jugador-card";
              Object.assign(nuevaCard.dataset, {
                nombre,
                numero,
                posicion,
                edad,
                img,
              });

              nuevaCard.innerHTML = `<img src="${img}" alt="${nombre}" class="img-thumbnail" />
          <p class="small">${numero} - ${nombre}</p>`;

              const container = document.querySelector(".jugadores-lista");
              container.insertBefore(
                nuevaCard,
                document.getElementById("add-jugador-btn")
              );

              asignarEventosJugadorCard(nuevaCard);
              guardarJugadorEnLocalStorage({
                nombre,
                numero,
                posicion,
                edad,
                img,
              });

              bootstrap.Modal.getInstance(
                document.getElementById("modalAddJugador")
              ).hide();
              form.reset();
            };

            if (file) {
              reader.readAsDataURL(file); // 👈 convierte a base64
            } else {
              alert("Por favor seleccioná una imagen.");
            }

            if (!nombre || !numero || !posicion || !edad) return;

            const nuevaCard = document.createElement("div");
            nuevaCard.className = "col text-center jugador-card";
            Object.assign(nuevaCard.dataset, {
              nombre,
              numero,
              posicion,
              edad,
              img,
            });

            nuevaCard.innerHTML = `<img src="${img}" alt="${nombre}" class="img-thumbnail" />
        <p class="small">${numero} - ${nombre}</p>`;

            const container = document.querySelector(".jugadores-lista");
            container.insertBefore(nuevaCard, addBtn);

            asignarEventosJugadorCard(nuevaCard);

            guardarJugadorEnLocalStorage({
              nombre,
              numero,
              posicion,
              edad,
              img,
            }); // ✅ Guardar

            bootstrap.Modal.getInstance(
              document.getElementById("modalAddJugador")
            ).hide();
            this.reset();
          });
        }
        cargarJugadoresDesdeLocalStorage();

        function cargarComentarios(nombre) {
          const comentarios =
            JSON.parse(localStorage.getItem("comentarios_" + nombre)) || [];
          const contenedor = document.getElementById("comentarios-lista");
          if (!contenedor) return;

          contenedor.innerHTML = "";
          comentarios
            .sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
            .forEach((c) => {
              const div = document.createElement("div");
              div.classList.add("border", "rounded", "p-2", "mb-2", "bg-light");
              div.innerHTML = `<strong>${c.fecha}</strong><br>${c.texto}`;
              contenedor.appendChild(div);
            });
        }

        function guardarComentario(nombre, texto) {
          const comentarios =
            JSON.parse(localStorage.getItem("comentarios_" + nombre)) || [];
          comentarios.push({ texto, fecha: new Date().toISOString() });
          localStorage.setItem(
            "comentarios_" + nombre,
            JSON.stringify(comentarios)
          );

          const overlay = document.getElementById("historialOverlay");
          if (!overlay.classList.contains("d-none")) {
            renderizarHistorial();
          }
        }

        const comentarBtn = document.getElementById("btn-comentar");
        if (comentarBtn) {
          comentarBtn.addEventListener("click", () => {
            const texto = document
              .getElementById("comentario-input")
              .value.trim();
            if (!texto || !jugadorActual) return;
            guardarComentario(jugadorActual, texto);
            document.getElementById("comentario-input").value = "";
          });
        }

        function renderizarHistorial() {
          const overlay = document.getElementById("historialOverlay");
          if (!overlay || !jugadorActual) return;

          const contenedor = overlay.querySelector(".overflow-auto");
          contenedor.innerHTML = "";

          const comentarios =
            JSON.parse(localStorage.getItem("comentarios_" + jugadorActual)) ||
            [];

          if (comentarios.length === 0) {
            contenedor.innerHTML = `
              <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                <p class="text-muted">Historial vacío</p>
              </div>
            `;
            overlay.classList.add("empty");
          } else {
            overlay.classList.remove("empty");
            comentarios
              .sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
              .forEach((c, index) => {
                const div = document.createElement("div");
                div.classList.add(
                  "timeline-entry",
                  index % 2 === 0 ? "left" : "right"
                );

                const fecha = new Date(c.fecha);
                const fechaTexto = `${String(fecha.getDate()).padStart(
                  2,
                  "0"
                )}-${String(fecha.getMonth() + 1).padStart(2, "0")}-${String(
                  fecha.getFullYear()
                ).slice(-2)}`;

                div.innerHTML = `
                  <div class="border rounded p-2 bg-white position-relative">
                    <div class="mb-1 text-muted small">${fechaTexto}</div>
                    <div class="comentario-texto">${c.texto}</div>
                    <div class="mt-2 text-end">
                      <button class="btn btn-sm btn-outline-secondary me-2 editar-btn">Editar</button>
                      <button class="btn btn-sm btn-outline-danger eliminar-btn">Eliminar</button>
                    </div>
                  </div>
                `;

                div
                  .querySelector(".editar-btn")
                  .addEventListener("click", () => {
                    const nuevoTexto = prompt("Editar comentario:", c.texto);
                    if (nuevoTexto?.trim()) {
                      comentarios[index].texto = nuevoTexto.trim();
                      localStorage.setItem(
                        "comentarios_" + jugadorActual,
                        JSON.stringify(comentarios)
                      );
                      renderizarHistorial();
                    }
                  });

                div
                  .querySelector(".eliminar-btn")
                  .addEventListener("click", () => {
                    if (confirm("¿Eliminar este comentario?")) {
                      comentarios.splice(index, 1);
                      localStorage.setItem(
                        "comentarios_" + jugadorActual,
                        JSON.stringify(comentarios)
                      );
                      renderizarHistorial();
                    }
                  });

                contenedor.appendChild(div);
              });
          }
        }

        function toggleHistorial() {
          const overlay = document.getElementById("historialOverlay");
          if (!overlay) return;

          if (overlay.classList.contains("d-none")) {
            renderizarHistorial();
            overlay.classList.remove("d-none");
          } else {
            overlay.classList.add("d-none");
          }
        }

        window.toggleHistorial = toggleHistorial; // 👈 importante si usas onclick="toggleHistorial()" en HTML

        const notasIcono = document.getElementById("notas-icono");
        if (notasIcono) {
          notasIcono.addEventListener("click", () => {
            document.getElementById("jugador-info").style.display = "none";
            document.getElementById("jugador-skeleton").style.display = "none";
            document.getElementById("calendario-panel").style.display = "none";
            document.getElementById("notas-panel").style.display = "block";
            cargarNotasGenerales();
          });
        }

        function cargarNotasGenerales() {
          const notas = JSON.parse(localStorage.getItem("notas-panel")) || [];
          const historial = document.getElementById("historial-notas");
          if (!historial) return;

          historial.innerHTML =
            notas.length === 0
              ? "<p class='text-muted'>No hay notas guardadas todavía.</p>"
              : "";

          notas
            .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
            .forEach((nota, i) => {
              const div = document.createElement("div");
              div.className = "border rounded p-2 mb-2 bg-light";
              div.innerHTML = `
              <strong>${new Date(nota.fecha).toLocaleString()}</strong><br>
              <div class="nota-texto">${nota.texto}</div>
              <div class="mt-2 text-end">
                <button class="btn btn-sm btn-outline-secondary me-2 editar-nota">Editar</button>
                <button class="btn btn-sm btn-outline-danger eliminar-nota">Eliminar</button>
              </div>
            `;

              div
                .querySelector(".editar-nota")
                .addEventListener("click", () => {
                  const nuevoTexto = prompt("Editar nota:", nota.texto);
                  if (nuevoTexto?.trim()) {
                    notas[i].texto = nuevoTexto.trim();
                    localStorage.setItem("notas-panel", JSON.stringify(notas));
                    cargarNotasGenerales();
                  }
                });

              div
                .querySelector(".eliminar-nota")
                .addEventListener("click", () => {
                  if (confirm("¿Eliminar esta nota?")) {
                    notas.splice(i, 1);
                    localStorage.setItem("notas-panel", JSON.stringify(notas));
                    cargarNotasGenerales();
                  }
                });

              historial.appendChild(div);
            });
        }

        const guardarNotaBtn = document.getElementById("btn-guardar-nota");
        if (guardarNotaBtn) {
          guardarNotaBtn.addEventListener("click", () => {
            const texto = document
              .getElementById("nota-general-input")
              .value.trim();
            if (!texto) return;

            const notas = JSON.parse(localStorage.getItem("notas-panel")) || [];
            notas.push({ texto, fecha: new Date().toISOString() });
            localStorage.setItem("notas-panel", JSON.stringify(notas));

            document.getElementById("nota-general-input").value = "";
            cargarNotasGenerales();
          });
        }

        // Mostrar el calendario
        const calendarioIcono = document.getElementById("calendario-icono");
        if (calendarioIcono) {
          calendarioIcono.addEventListener("click", () => {
            document.getElementById("jugador-info").style.display = "none";
            document.getElementById("notas-panel").style.display = "none";
            document.getElementById("jugador-skeleton").style.display = "none";
            document.getElementById("calendario-panel").style.display = "block";

            if (!window.calendarioIniciado) {
              iniciarCalendario();
              window.calendarioIniciado = true;
            }
          });
        }

        // Iniciar FullCalendar con edición, eliminación y guardado local
        function iniciarCalendario() {
          const calendarEl = document.getElementById("fullcalendar");
          const eventosGuardados =
            JSON.parse(localStorage.getItem("eventosCalendario")) || [];

          const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            locale: "es",
            selectable: true,
            editable: true,
            eventDidMount: function (info) {
              const acciones = document.createElement("div");
              acciones.className = "event-actions";

              // Botón editar
              const btnEditar = document.createElement("button");
              btnEditar.textContent = "Editar";
              btnEditar.className = "editar";
              btnEditar.onclick = (e) => {
                e.stopPropagation();
                const nuevoTitulo = prompt(
                  "Nuevo título del evento:",
                  info.event.title
                );
                if (nuevoTitulo) {
                  info.event.setProp("title", nuevoTitulo);
                  guardarEventosLocalmente(info.view.calendar);
                }
              };

              // Botón eliminar
              const btnEliminar = document.createElement("button");
              btnEliminar.textContent = "Eliminar";
              btnEliminar.className = "eliminar";
              btnEliminar.onclick = (e) => {
                e.stopPropagation();
                const confirmar = confirm(
                  `¿Eliminar el evento "${info.event.title}"?`
                );
                if (confirmar) {
                  info.event.remove();
                  guardarEventosLocalmente(info.view.calendar);
                }
              };

              acciones.appendChild(btnEditar);
              acciones.appendChild(btnEliminar);
              info.el.appendChild(acciones);
            },
            dateClick: function (info) {
              const fecha = info.dateStr;
              const hora = prompt(
                "Introduce la hora del evento (24h, ej. 14:30):"
              );
              if (!hora) return;
              const titulo = prompt("Introduce el título del evento:");
              if (!titulo) return;

              const start = new Date(`${fecha}T${hora}`);
              const end = new Date(start.getTime() + 30 * 60 * 1000);

              calendar.addEvent({
                title: titulo,
                start: start.toISOString(),
                end: end.toISOString(),
              });

              guardarEventosLocalmente(calendar);

              // Abrir Google Calendar
              const formatDate = (d) =>
                d.toISOString().replace(/-|:|\.\d+/g, "");
              const url =
                `https://calendar.google.com/calendar/render?action=TEMPLATE` +
                `&text=${encodeURIComponent(titulo)}` +
                `&dates=${formatDate(start)}/${formatDate(end)}` +
                `&details=${encodeURIComponent(
                  "Consulta médica con jugador"
                )}` +
                `&sf=true&output=xml`;
              window.open(url, "_blank");
            },
          });

          // Cargar eventos guardados localmente
          eventosGuardados.forEach((evento) => calendar.addEvent(evento));

          calendar.render();

          window.miCalendario = calendar; // por si quieres acceder desde consola
        }

        // Guardar eventos actuales en localStorage
        function guardarEventosLocalmente(calendar) {
          const eventos = calendar.getEvents().map((event) => ({
            title: event.title,
            start: event.start.toISOString(),
            end: event.end.toISOString(),
          }));
          localStorage.setItem("eventosCalendario", JSON.stringify(eventos));
        }

        function mostrarSoloPanel(idVisible) {
          const paneles = [
            "jugador-info",
            "jugador-skeleton",
            "notas-panel",
            "calendario-panel",
          ];

          paneles.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.style.display = id === idVisible ? "block" : "none";
          });
        }
      });
    </script>
  </body>
</html>